<!doctype html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>Login</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">

            <a class="navbar-brand" href="HomePage.html">Figure Shop</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="Login.html">LOGIN</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Register.html">REGISTER</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- LOGIN -->
    <!--<h2>Login</h2>

    <form id="loginForm">
        <label>
            Email:
            <input id="ue" required>
        </label><br>
        <label>
            Password:
            <input id="pw" type="password" required>
        </label><br>
        <button type="submit">Login</button>
    </form>-->

    <p id="msg"></p>
    <main class="container">
      <div class="row justify-content-center mt-5">
        <div class="col-md-6 col-lg-5">

          <div class="card shadow-sm">
            <div class="card-body p-4">
              
              <h2 class="card-title text-center mb-4">Log In</h2>
              
              <form id="loginForm" >
                <div class="mb-3">
                  <label for="email" class="form-label">Email:</label>
                  <input type="text" class="form-control" id="ue" name="email" required>
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password:</label>
                  <input type="password" class="form-control" id="pw" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-3">Log In</button>
              </form>

              <p class="text-center mt-4">
                Don't have an account? <a href="Register.html">Register here</a>.
              </p>

            </div>
          </div>
        </div>
      </div>
    </main>


    <script>
        // ชี้ไปที่ .svc แบบ relative จาก /View/Login.html
        const API = new URL('../Services/dbService.svc', location.href).href;
        //fetch('/Services/dbService.svc/login', {
        //    method: 'POST',
        //    headers: { 'Content-Type': 'application/json' },
        //    body: JSON.stringify({ email, password })
        //})

        // องค์ประกอบในหน้า
        const form = document.getElementById('loginForm');
        const emailEl = document.getElementById('email') || document.getElementById('ue'); // ← รองรับทั้งสองชื่อ
        const pwEl = document.getElementById('pw');
        const msgEl = document.getElementById('msg') || (() => {
            const p = document.createElement('p'); p.id = 'msg'; document.body.appendChild(p); return p;
        })();

        // ถ้าหน้าไม่มี id ตามนี้ ให้เตือนทันที
        if (!form || !emailEl || !pwEl) {
            alert('กรุณาตรวจ: ต้องมี form#loginForm, input#email (หรือ #ue), input#pw');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = (emailEl.value || '').trim();
            const password = pwEl.value || '';

            // ตรวจค่าว่าง
            if (!email) { alert('กรอกอีเมลก่อน'); emailEl.focus(); return; }
            if (!password) { alert('กรอกรหัสผ่านก่อน'); pwEl.focus(); return; }

            // ปิดปุ่มระหว่างโหลด
            const btn = form.querySelector('button[type="submit"]');
            btn && (btn.disabled = true);
            msgEl.textContent = 'กำลังเข้าสู่ระบบ…';

            try {
                // 1) เรียก Login
                const r = await fetch(`${API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const txt = (await r.text()).replace(/"/g, ''); // "success" | "fail"

                if (!r.ok) {
                    alert(`เซิร์ฟเวอร์ตอบผิดพลาด (${r.status})`);
                    msgEl.textContent = '';
                    return;
                }
                if (txt !== 'success') {
                    alert('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    msgEl.textContent = '';
                    return;
                }

                // 2) ขอ role เพื่อเลือกหน้า
                const r2 = await fetch(`${API}/user/role-by-email/${encodeURIComponent(email)}`);
                const role = (await r2.text()).replace(/"/g, '') || 'customer';

                // เก็บไว้ใช้ต่อหน้าอื่น ๆ
                localStorage.setItem('email', email);
                localStorage.setItem('role', role);

                // 3) ไปหน้าที่ต้องการ
                location.href = (role === 'admin') ? 'Catalogs.html' : 'Catalogs.html';
            } catch (err) {
                console.error(err);
                alert('ติดต่อเซิร์ฟเวอร์ไม่ได้');
            } finally {
                btn && (btn.disabled = false);
                msgEl.textContent = '';
            }
        });
    </script>






</body>
</html>
