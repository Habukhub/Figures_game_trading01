<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>Figure Shop - Edit Product</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar (เหมือนหน้าอื่นๆ) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="home.html">Figure Shop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#loggedInNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="loggedInNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item" id="navAddProduct"><a class="nav-link" href="AddProduct.html">Add Product</a></li>
                    <li class="nav-item" id="navManageProduct"><a class="nav-link" href="Admin.html">Manage Product</a></li>
                    <li class="nav-item"><a class="nav-link" href="Catalogs.html">Catalogs</a></li>
                    <li class="nav-item"><a class="nav-link" href="History.html">Profile (ประวัติการซื้อ)</a></li>
                    <li class="nav-item"><a class="nav-link" id="btnLogout" href="#">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4">
        <h2 class="mb-3">Edit Product</h2>

        <div id="alert" class="alert d-none" role="alert"></div>

        <form id="editForm" class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-7">
                        <div class="mb-2">
                            <label class="form-label">ชื่อสินค้า</label>
                            <input id="name" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">ราคาเริ่มต้น (฿)</label>
                            <input id="price" type="number" step="0.01" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">รูปภาพ (URL หลายรูปคั่นด้วย | )</label>
                            <input id="imgs" class="form-control" placeholder="https://...|https://...">
                            <div class="form-text">รูปแรกจะถูกใช้แสดงเป็นภาพหน้าปก</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">สถานะ</label>
                            <select id="status" class="form-select">
                                <option value="active">active</option>
                                <option value="ended">ended</option>
                                <option value="sold">sold</option>
                                <option value="archived">archived</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">เวลาสิ้นสุด (ถ้าไม่เปลี่ยนปล่อยว่าง)</label>
                            <input id="endsAt" type="datetime-local" class="form-control" placeholder="2025-10-31T15:30">
                            <div class="form-text">
                                ใช้เวลาท้องถิ่นเครื่องคุณ (จะถูกแปลงเป็น UTC ฝั่งเซิร์ฟเวอร์)
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="border rounded p-2 bg-light">
                            <div class="ratio ratio-4x3 mb-2">
                                <img id="preview" src="https://placehold.co/800x600?text=Preview" alt="preview" class="img-fluid rounded" style="object-fit:cover;">
                            </div>
                            <div class="small text-muted">
                                <div>Item ID: <span id="lblId">-</span></div>
                                <div>ราคาปัจจุบัน: ฿<span id="lblCurrent">-</span></div>
                                <div>เหลือเวลา: <span id="lblRemain">-</span></div>
                                <div>สิ้นสุด (จากเซิร์ฟเวอร์): <span id="lblEnds">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                    <a class="btn btn-outline-secondary" href="Admin.html">ย้อนกลับ</a>
                    <button class="btn btn-primary" type="submit">บันทึก</button>
                </div>
            </div>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  (function(){
    // guard: ต้องล็อกอินเป็น admin
    const role = (localStorage.getItem('role')||'').toLowerCase();
    if (role !== 'admin') { location.href = 'Catalogs.html'; return; }

    // แสดง/ซ่อนเมนูเฉพาะ admin
    ['navAddProduct','navManageProduct'].forEach(id=>{
      const el = document.getElementById(id); if (el) el.style.display = role==='admin' ? '' : 'none';
    });

    // logout
    document.getElementById('btnLogout')?.addEventListener('click', (e)=>{
      e.preventDefault(); localStorage.clear(); location.href='HomePage.html';
    });

    const email = localStorage.getItem('email') || '';
    const API   = new URL('../Services/dbService.svc', location.href).href;
    const qs    = new URLSearchParams(location.search);
    const id    = qs.get('id');

    if (!id) { showAlert('danger', 'ไม่พบ parameter id ใน URL'); return; }

    const dom = {
      alert: document.getElementById('alert'),
      form:  document.getElementById('editForm'),
      name:  document.getElementById('name'),
      price: document.getElementById('price'),
      imgs:  document.getElementById('imgs'),
      status:document.getElementById('status'),
      endsAt:document.getElementById('endsAt'),
      preview:document.getElementById('preview'),
      lblId: document.getElementById('lblId'),
      lblCurrent: document.getElementById('lblCurrent'),
      lblRemain: document.getElementById('lblRemain'),
      lblEnds: document.getElementById('lblEnds')
    };

    function showAlert(type, msg){
      dom.alert.className = 'alert alert-'+type;
      dom.alert.textContent = msg;
      dom.alert.classList.remove('d-none');
    }

    function firstImg(s){
      if (!s) return '';
      const i = s.indexOf('|'); return i>=0 ? s.slice(0,i) : s;
    }
    function fmtMoney(n){ return Number(n||0).toLocaleString(); }
    function fmtRemain(sec){
      sec = Math.max(0, Number(sec||0)|0);
      const d=Math.floor(sec/86400); sec%=86400;
      const h=Math.floor(sec/3600); sec%=3600;
      const m=Math.floor(sec/60); const s=sec%60;
      return (d?`${d}d `:'')+[h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
    }

    async function getItem(){
      // ลองเรียกสองแบบที่โปรเจ็กต์คุณใช้
      const urls = [
        `${API}/catalog/${encodeURIComponent(id)}/view`,
        `${API}/GetCatalogByIdView?id=${encodeURIComponent(id)}`
      ];
      for (const u of urls) {
        try { const r = await fetch(u); if (r.ok) return await r.json(); } catch(e){}
      }
      throw new Error('ไม่พบ endpoint สำหรับดึงข้อมูลสินค้า');
    }

    function initForm(it){
      dom.lblId.textContent = it.item_id;
      dom.name.value = it.name || '';
      dom.price.value = (it.price ?? it.price_start ?? 0);
      dom.status.value = it.status || 'active';
      dom.lblEnds.textContent = (it.ends_at||'').replace('T',' ');
      dom.lblRemain.textContent = fmtRemain(it.remaining_seconds||0);
      dom.lblCurrent.textContent = fmtMoney(it.current_price ?? Math.max(it.price||0, it.top_bid||0));

      // ถ้า API ของคุณไม่ส่ง Imgs ทั้งหมด ก็ให้ตั้งจาก Img เดี่ยว
      dom.imgs.value = it.Imgs || it.Img || '';
      const pv = it.Img || firstImg(dom.imgs.value) || 'https://placehold.co/800x600?text=Preview';
      dom.preview.src = pv;

      // อัปเดตพรีวิวเมื่อแก้ช่อง imgs
      dom.imgs.addEventListener('input', ()=>{
        dom.preview.src = firstImg(dom.imgs.value) || 'https://placehold.co/800x600?text=Preview';
      });
    }

    // โหลดข้อมูลตอนเปิดหน้า
    (async ()=>{
      try{
        const it = await getItem();
        if (!it || !it.item_id) { showAlert('danger','ไม่พบสินค้า id='+id); return; }
        initForm(it);
      }catch(err){
        console.error(err);
        showAlert('danger','โหลดข้อมูลไม่สำเร็จ');
      }
    })();

    // บันทึก
    dom.form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const adminEmail = email;
      const payload = {
        adminEmail,
        item_id: Number(id),
        name: dom.name.value.trim(),
        price: parseFloat(dom.price.value),
        Imgs: dom.imgs.value.trim(),
        status: dom.status.value,
        endsAtISO: dom.endsAt.value ? dom.endsAt.value : undefined  // ว่าง = ไม่เปลี่ยน
      };

      if (!payload.name || !(payload.price>=0)) {
        showAlert('warning','กรุณากรอกชื่อและราคาเริ่มต้นให้ถูกต้อง'); return;
      }

      const urls = [
        `${API}/catalog/update`,
        `${API}/UpdateCatalog`
      ];
      let ok = false, last = '';
      for (const u of urls) {
        try {
          const r = await fetch(u, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          last = (await r.text()).replace(/"/g,'').trim();
          if (r.ok && (last==='success' || last==='ok')) { ok = true; break; }
        } catch (e) { last = String(e); }
      }

      if (ok) {
        showAlert('success','บันทึกสำเร็จ');
        setTimeout(()=>location.href='Admin.html', 800);
      } else {
        showAlert('danger','บันทึกไม่สำเร็จ: '+ last);
      }
    });

  })();
    </script>
</body>
</html>
