<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figure Shop - Bidding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="HomePage.html">Figure Shop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#loggedInNavbar" aria-controls="loggedInNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="loggedInNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item" id="navAddProduct">
                        <a class="nav-link" href="AddProduct.html">Add Product</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Catalogs.html">Catalogs</a>
                    </li>
                    <li class="nav-item" id="navManageProduct">
                        <a class="nav-link" href="Admin.html">Manage Product</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="history.html">Profile (ประวัติการซื้อ)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="HomePage.html">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div id="bidding-loading" class="text-center">
            <p>Loading auction item...</p>
        </div>
        <div class="row" id="bidding-content-container">
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API = new URL('../Services/dbService.svc', location.href).href;
            const content = document.getElementById('bidding-content-container');
            const loading = document.getElementById('bidding-loading');

            const itemId = new URLSearchParams(location.search).get('id');
            const email = localStorage.getItem('email') || '';
            const STEP = 100; // ขั้นบิดขั้นต่ำ

            const fmtRemain = s => {
                s = Math.max(0, s | 0);
                const d = Math.floor(s / 86400); s %= 86400;
                const h = Math.floor(s / 3600); s %= 3600;
                const m = Math.floor(s / 60); const ss = s % 60;
                return (d ? d + 'd ' : '') + [h, m, ss].map(n => String(n).padStart(2, '0')).join(':');
            };
            const money = n => '฿' + Number(n || 0).toLocaleString();

            async function load() {
                const r = await fetch(`${API}/catalog/${encodeURIComponent(itemId)}/view`);
                if (!r.ok) throw new Error('load fail');
                return r.json();
            }
            async function closeExpired() {
                try { await fetch(`${API}/auction/close-expired`, { method: 'POST' }); } catch { }
            }

            try {
                const it = await load();
                loading.style.display = 'none';
                if (!it || !it.item_id) {
                    content.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">ไม่พบสินค้า</div></div>`;
                    return;
                }

                let remain = it.remaining_seconds | 0;
                // ✅ ราคาปัจจุบัน = max(ราคาเริ่มต้น, บิดสูงสุด)
                let current = Math.max(Number(it.price || 0), Number(it.top_bid || 0));

                content.innerHTML = `
          <div class="col-md-7">
            <img src="${it.Img || 'https://placehold.co/800x600?text=No+Image'}"
                 class="img-fluid rounded shadow-sm" alt="${it.name}">
          </div>
          <div class="col-md-5">
            <h1>${it.name}</h1><hr>
            <p class="text-muted mb-1">เวลาที่เหลือ:</p>
            <h3 class="text-danger mb-3"><span id="timer">${fmtRemain(remain)}</span></h3>

            <p class="text-muted mb-1">ราคาสูงสุดตอนนี้:</p>
            <h2 class="mb-4"><span id="top">${money(current)}</span></h2>

            <div class="alert alert-info"><strong>สถานะ:</strong> ${it.status}</div>

            <form id="bid-form">
              <div class="mb-3">
                <label for="bid-amount" class="form-label fs-5">สู้ราคา</label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text">฿</span>
                  <input type="number" class="form-control" id="bid-amount"
                         placeholder="${current + STEP}" min="${current + STEP}" step="1" required>
                  <button class="btn btn-success" type="submit">Bid</button>
                </div>
                <div class="form-text">ต้องใส่มากกว่า ${money(current)} อย่างน้อย ${STEP}</div>
              </div>
            </form>
          </div>`;

                const timerEl = document.getElementById('timer');
                const topEl = document.getElementById('top');
                const form = document.getElementById('bid-form');
                const amountEl = document.getElementById('bid-amount');

                // เคาท์ดาวน์
                const tick = setInterval(async () => {
                    if (remain > 0) {
                        remain--; timerEl.textContent = fmtRemain(remain);
                    } else {
                        clearInterval(tick);
                        form.querySelector('button').disabled = true;
                        await closeExpired();
                        const after = await load();
                        if (after && after.status !== 'active') {
                            alert('หมดเวลาแล้ว ระบบกำลังสรุปผล');
                            location.href = 'history.html';
                        }
                    }
                }, 1000);

                // ✅ poll อัปเดตราคา/เวลา ทุก 3 วิ ให้ตรงกับเซิร์ฟเวอร์
                setInterval(async () => {
                    try {
                        const now = await load();
                        const newCurrent = Math.max(Number(now.price || 0), Number(now.top_bid || 0));
                        remain = now.remaining_seconds | 0;

                        if (newCurrent !== current) {
                            current = newCurrent;
                            topEl.textContent = money(current);
                            // อัปเดตคำใบ้/ขั้นต่ำของช่องกรอก
                            amountEl.placeholder = String(current + STEP);
                            amountEl.min = String(current + STEP);
                            amountEl.value = '';
                        }
                    } catch { }
                }, 3000);

                // ส่งบิด
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!email) { alert('กรุณาเข้าสู่ระบบก่อน'); location.href = 'Login.html'; return; }
                    if (remain <= 0) { alert('หมดเวลาแล้ว'); return; }

                    const amount = parseFloat(amountEl.value);
                    if (!(amount > current)) { alert(`ต้องมากกว่า ${money(current)}`); return; }

                    try {
                        const r = await fetch(`${API}/bid`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, item_id: Number(itemId), amount })
                        });
                        const out = await r.json();

                        if (out.status === 'success') {
                            current = Math.max(current, Number(out.top_bid || 0));
                            topEl.textContent = money(current);
                            amountEl.placeholder = String(current + STEP);
                            amountEl.min = String(current + STEP);
                            amountEl.value = '';
                            alert('บิดสำเร็จ!');
                        } else if (out.status === 'too_low') {
                            current = Math.max(current, Number(out.top_bid || 0)); // sync ให้ทัน
                            topEl.textContent = money(current);
                            amountEl.placeholder = String(current + STEP);
                            amountEl.min = String(current + STEP);
                            alert('ราคาต่ำเกินไป (ปัจจุบัน: ' + money(out.top_bid) + ')');
                        } else if (out.status === 'ended') {
                            alert('หมดเวลาแล้ว'); location.reload();
                        } else {
                            alert('บิดไม่สำเร็จ: ' + out.status);
                        }
                    } catch (err) {
                        alert('บิดไม่สำเร็จ (เครือข่าย)');
                    }
                });
            } catch (e) {
                loading.style.display = 'none';
                content.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">โหลดข้อมูลล้มเหลว</div></div>`;
            }
        });


        // ซ่อนเมนู AddProduct/ManageProduct เมื่อไม่ใช่ admin
        document.addEventListener('DOMContentLoaded', () => {
            const isAdmin = (localStorage.getItem('role') || '').toLowerCase() === 'admin';
            ['navAddProduct', 'navManageProduct'].forEach(id => {
                let el = document.getElementById(id);
                if (!el) return;
                const li = el.closest('li');
                if (li) el = li;
                el.classList.toggle('d-none', !isAdmin);
            });
        });
    </script>


</body>
</html>